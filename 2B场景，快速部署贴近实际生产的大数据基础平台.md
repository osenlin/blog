# 1. 现状与思考  

在实践大数据基础平台docker化，也遇到了一些问题，我通过下面一个比较实际的例子来谈谈。
## 1.1. 背景介绍
基础服务用docker封装。在docker之上我们用rancher来管理我们的docker集群,所有大数据组件基本用的都是apache community edition。
## 1.2 例子
### 1.2.1 hdfs docker化
在对hdfs服务进行docker化中，考虑到生产环境需要引入HA，所以需要引入failover controller node，要保证Namenode与secondary节点的通信需要引入journalnode。出于安全的考虑不能把集群所有主机都暴露出来，需要一个或者若干gateway。考虑到线上的快速恢复，也需要引入backup node。也就是说为了部署一个能够上生产的hdfs基础组件，需要部署namenode，secondary namenode，datanode，journalnode，failovercontraoller node，backup node，gateway node6个服务（完整情况下应该是8个）。借鉴对docker的最佳实践，我们一个container只部署一个服务。我们至少需要编写6个dockerfile。编写完后，我们通过docker-compose结合rancher来管理我们的服务。通过rancher 进行容器的编排。
### 1.2.2 yarn等资源调度的引入
接下来我真的引入了yarn，yarn 需要引入jobhistory，resourcemanager ,nodemanager 三个服务，对hadoop的hdfs-site，yarn-site等配置文件进行修改，我们需要对前面的dockerfile中配置文件进行一个个更改并且重新build，push，deploy。为了docker中yarn能组合上hdfs，上面过程反复开发测试，这种行为非常低效。所以借鉴IOC的想法。引入动态参数调整，就是为了应对后期大量的且频繁的调优，以及对接可能会对接的组件（eg：yarn）引起的配置参数的变更。为了应对的可能的变化，我们引入了多个shell，定义了常见的大几十个变量。编写了大量的sed替换代码。
### 1.2.3 代码盘点
后面维护的同学，仅仅俩个基础组件需要维护：6个hdfs的dockerfile，3个yarn的dockerfile，以及若干shell脚本，若干配置文件，另外要保证俩个组件组合共用的配置文件需要在多个image中保持一致
### 1.2.4 项目上线
我们通过rancher来管理我们的docker并进行服务的编排和调度。所以我们需要对所有的服务器进行针对各个组建一一进行统一的标签化，eg：hdfs定义标签hd.role.namenode=true,hd.role.datanode=true,yarn定义标yarn.role.rm=true,yarn.role.nm=true,etc。确保服务器能够争取的部署到我想要部署的服务器。思考下图dockerfile中的服务如何才能更好在docker中进行管理和部署？如果还有其他的组件呢spark,hive，hbase，kafka，zookeeper？  
![](./2B场景，快速部署贴近实际生产的大数据基础平台/1.png)

## 1.3 有待完善的事情
在1.2中我们描述了一个完整组件上生产需要考虑的基础性问题。但远远不够，还需要考虑管理，运营，安全等方面的问题。先蛮罗列下几个点后续在补充
### 1.3.1 管理问题
1. 资源的统一管理
2. 多集群的管理（hadoop，kafka，zookeepr）
3. 日志统一管理和节点定位
4. 集群疾病与诊断史 
### 1.3.2 部署
1. 升级部署，不是推到重来
2. 统一的配置管理
3. 管理不同服务的启停备份
4. 多host管理（vm，物理机，docker）
5. 配置审计跟踪
6. 配置版本控制和历史记录
### 1.3.3 安全与运营
1. 针对不通组件的软件监控指标
2. 系统硬件的监控指标
3. 报警管理
4. 安全认证
5. 服务、主机和活动监控

## 1.4 小结
a. 通过rancher结合docker更好实现单个组件多个服务的编排，以及满足线上要求的服务与管理运维（eg：一个hdfs完成的组建有8个（namenode，secondarynamenode，datanode，journalnode，failover controller etc）
a. 如何通过rancher集合docker更好管理多个组件组合的服务编排和以及满足线上要求的服务与配置管理。  

# 2 尝试的部署架构改进  
我们用cloudera manager结合实际场景下对docker使用方式做了姿势上的调整。所以本节分为俩部分 cloudera manager（cdm）以及docker结合cdm的使用方式调整
## 2.1 cloudera manager
先来看看cdm官网提供的架构图，如下图  
![](./2B场景，快速部署贴近实际生产的大数据基础平台/2.png)
上面描述了几个组件  
- Agent：安装在每台主机上。该代理负责启动和停止的过程，拆包配置，触发装置和监控主机。  
- Management Service：由一组执行各种监控，警报和报告功能角色的服务。  
- Database：存储配置和监视信息。通常情况下，多个逻辑数据库在一个或多个数据库服务器上运行。  
- Cloudera Repository：cloudera 软件包的公有源
- client
    - Admin Console - 基于Web的用户界面与管理员管理集群和Cloudera管理。
    - API - 与开发人员创建自定义的Cloudera Manager应用程序的API。

一句话总结下CDM：核心组建是Management Service，该服务承载管理控制台的Web服务器和应用程序逻辑，并负责安装软件，配置，启动和停止服务，以及管理上的服务运行群集。